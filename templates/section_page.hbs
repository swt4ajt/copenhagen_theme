<div class="container-divider"></div>
<div class="container">
    <div class="sub-nav">
        {{breadcrumbs}}
        <div class="search-container">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" focusable="false" viewBox="0 0 12 12" class="search-icon" aria-hidden="true">
                <circle cx="4.5" cy="4.5" r="4" fill="none" stroke="currentColor"/>
                <path stroke="currentColor" stroke-linecap="round" d="M11 11L7.5 7.5"/>
            </svg>
            {{search scoped=settings.scoped_kb_search submit=false}}
        </div>
    </div>

    <div class="section-container">
        <section id="main-content" class="section-content">
            <header class="page-header">
                <h1>{{section.name}}</h1>
                {{#if settings.show_follow_section}}
                    <div class="section-subscribe">{{subscribe}}</div>
                {{/if}}
                {{#if section.description}}
                    <p class="page-header-description">{{section.description}}</p>
                {{/if}}
            </header>

            {{#if section.sections}}
                <ul class="section-list">
                    {{#each section.sections}}
                        <li class="section-list-item">
                            <a href="{{url}}">
                                <span>{{name}}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" focusable="false" viewBox="0 0 16 16" aria-hidden="true">
                                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M5 14.5l6.1-6.1c.2-.2.2-.5 0-.7L5 1.5"/>
                                </svg>
                            </a>
                        </li>
                    {{/each}}
                </ul>
            {{/if}}

            {{pagination "section.sections"}}

            {{#if section.articles}}
                {{#is section.id 4964692123039}}
                {{!-- Tiled grid for the Introductions section --}}
                    <div id="introductions-grid" class="introductions-grid-4wide">
                        {{#each section.articles}}
                            <article
                                    class="intro-item"
                                    data-article-id="{{id}}"
                                    aria-labelledby="intro-title-{{id}}"
                            >
                                <a href="{{url}}">
                                    <img
                                            class="intro-img"
                                            src="{{asset 'image-pending.jpg'}}"
                                            alt="Article image"
                                            loading="lazy"
                                    />
                                    <h3 id="intro-title-{{id}}" class="intro-title">{{title}}</h3>
                                    <p class="intro-excerpt">
                                        {{#if excerpt}}
                                            {{excerpt}}
                                        {{else}}
                                            Loading preview…
                                        {{/if}}
                                    </p>
                                </a>
                            </article>
                        {{/each}}
                    </div>

                    {{!-- Inline, safe JS to hydrate each tile from the article body --}}
                    <script>
                        (function () {
                          'use strict';

                          // Derive locale from Help Center or URL
                          var locale = (window.HelpCenter && HelpCenter.user && HelpCenter.user.locale) ||
                                       (function () {
                                         var m = location.pathname.match(/\/hc\/([^/]+)/);
                                         return (m && m[1]) || 'en-us';
                                       })();

                          function firstImageSrc(html) {
                            var m = html && html.match(/<img[^>]+src="([^"]+)"/i);
                            return m ? m[1] : null;
                          }

                          function stripHtml(html) {
                            var tmp = document.createElement('div');
                            tmp.innerHTML = html || '';
                            return (tmp.textContent || tmp.innerText || '').replace(/\s+/g, ' ').trim();
                          }

                          function truncateWords(text, n) {
                            var parts = (text || '').split(/\s+/).filter(Boolean);
                            if (parts.length <= n) return text || '';
                            return parts.slice(0, n).join(' ') + '…';
                          }

                          function hydrateTile(tile) {
                            var id = tile.getAttribute('data-article-id');
                            if (!id) return;

                            var apiUrl = '/api/v2/help_center/' + locale + '/articles/' + id + '.json';

                            fetch(apiUrl)
                              .then(function (r) { return r.ok ? r.json() : null; })
                              .then(function (data) {
                                if (!data || !data.article) return;
                                var body = data.article.body || '';
                                var title = data.article.title || '';
                                var img = firstImageSrc(body) || '{{asset "image-pending.jpg"}}';
                    var text = truncateWords(stripHtml(body), 40);

                    var imgEl = tile.querySelector('.intro-img');
                    if (imgEl) imgEl.src = img;

                    var titleEl = tile.querySelector('.intro-title');
                    if (titleEl && title) titleEl.textContent = title;

                    var p = tile.querySelector('.intro-excerpt');
                    if (p) p.textContent = text || 'No description available.';
                  })
                  .catch(function () { /* swallow errors per tile */ });
              }

              document.addEventListener('DOMContentLoaded', function () {
                var grid = document.getElementById('introductions-grid');
                if (!grid) return;
                var tiles = grid.querySelectorAll('.intro-item[data-article-id]');
                tiles.forEach ? tiles.forEach(hydrateTile) : Array.prototype.forEach.call(tiles, hydrateTile);
              });
            })();
                    </script>
                {{else}}
                {{!-- Default list for all other sections --}}
                    <ul class="article-list">
                        {{#each section.articles}}
                            <li class="article-list-item {{#if promoted}}article-promoted{{/if}}">
                                {{#if promoted}}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" focusable="false" viewBox="0 0 12 12" class="icon-star">
                                        <path fill="currentColor" d="M2.88 11.73c-.19 0-.39-.06-.55-.18a.938.938 0 01-.37-1.01l.8-3L.35 5.57a.938.938 0 01-.3-1.03c.12-.37.45-.63.85-.65L4 3.73 5.12.83c.14-.37.49-.61.88-.61s.74.24.88.6L8 3.73l3.11.17a.946.946 0 01.55 1.68L9.24 7.53l.8 3a.95.95 0 01-1.43 1.04L6 9.88l-2.61 1.69c-.16.1-.34.16-.51.16z"/>
                                    </svg>
                                {{/if}}
                                <a href="{{url}}" class="article-list-link">{{title}}</a>
                                {{#if internal}}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" focusable="false" viewBox="0 0 16 16" class="icon-lock">
                                        <rect width="12" height="9" x="2" y="7" fill="currentColor" rx="1" ry="1"/>
                                        <path fill="none" stroke="currentColor" d="M4.5 7.5V4a3.5 3.5 0 017 0v3.5"/>
                                    </svg>
                                {{/if}}
                            </li>
                        {{/each}}
                    </ul>
                {{/is}}
            {{else}}
                <i class="section-empty">
                    <a href="{{section.url}}">{{t 'empty'}}</a>
                </i>
            {{/if}}

            {{pagination "section.articles"}}
        </section>
    </div>
</div>
